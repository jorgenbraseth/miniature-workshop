# Miniature Workshop Backend

This is the serverless backend API for Miniature Workshop, built with AWS Lambda, DynamoDB, and S3.

## Architecture

- **Runtime**: Node.js 18.x with TypeScript
- **API Gateway**: HTTP API with CORS support
- **Database**: DynamoDB with GSI indexes for efficient querying
- **Storage**: S3 for image storage with presigned URLs
- **Authentication**: Google OAuth 2.0 token verification
- **Infrastructure**: Serverless Framework for AWS deployment

## Prerequisites

1. **AWS CLI** configured with appropriate permissions
2. **Node.js** 18.x or higher
3. **Serverless Framework** CLI (`npm install -g serverless`)
4. **Google Cloud Console** project with OAuth 2.0 credentials

## Setup

1. **Install dependencies**:
   ```bash
   npm install
   ```

2. **Configure environment variables**:
   ```bash
   # Set your Google OAuth client ID
   export GOOGLE_CLIENT_ID="your-client-id.apps.googleusercontent.com"
   ```

3. **Deploy to AWS**:
   ```bash
   # Deploy to production
   npm run deploy
   ```

## API Endpoints

### Authentication
- `POST /auth/verify` - Verify Google OAuth token and create/login user
- `GET /auth/user` - Get current authenticated user

### Units
- `GET /units` - List units (public or user's units with `?scope=user`)
- `GET /units/{id}` - Get specific unit
- `POST /units` - Create new unit (authenticated)
- `PUT /units/{id}` - Update unit (authenticated, owner only)
- `DELETE /units/{id}` - Delete unit (authenticated, owner only)

### Steps
- `POST /units/{unitId}/steps` - Create step in unit (authenticated, owner only)
- `PUT /units/{unitId}/steps/{stepId}` - Update step (authenticated, owner only)
- `DELETE /units/{unitId}/steps/{stepId}` - Delete step (authenticated, owner only)

### Images
- `POST /images/upload-url` - Get presigned URL for image upload (authenticated)
- `POST /images/upload` - Direct image upload (not implemented, use presigned URL)

### Sync
- `POST /sync` - Sync data from frontend (authenticated)
- `GET /sync/status` - Get sync status (authenticated)

## Authentication

All protected endpoints require a `Bearer` token in the `Authorization` header:

```
Authorization: Bearer <google-oauth-token>
```

The token is verified against Google's OAuth 2.0 service.

## Data Models

### Unit
- Contains painting project information
- Has multiple steps with techniques and photos
- Can be public or private
- Tracks sync status for offline-first functionality

### Step
- Individual painting steps within a unit
- Contains technique details, paints used, tools, and photos
- Can apply to specific models within the unit

### Photo
- Stored in S3 with metadata
- Supports different types: detail, full_model, unit_overview
- Can be public or private

## Development

1. **Run locally** (requires `serverless-offline`):
   ```bash
   npm run offline
   ```

2. **Run tests**:
   ```bash
   npm test
   ```

3. **Lint code**:
   ```bash
   npm run lint
   ```

4. **Build TypeScript**:
   ```bash
   npm run build
   ```

## Deployment

The backend deploys to production:

- **Production**: `npm run deploy`

This creates AWS resources with production-specific names.

## Environment Variables

Required environment variables:

- `GOOGLE_CLIENT_ID` - Google OAuth 2.0 client ID
- `REGION` - AWS region (default: us-east-1)

Auto-generated by Serverless Framework:
- `UNITS_TABLE` - DynamoDB table for units
- `USERS_TABLE` - DynamoDB table for users
- `SYNC_QUEUE_TABLE` - DynamoDB table for sync queue
- `IMAGES_BUCKET` - S3 bucket for images

## Cost Optimization

The backend is designed for cost efficiency:

- **DynamoDB**: Pay-per-request pricing
- **Lambda**: Pay-per-invocation with generous free tier
- **S3**: Standard storage with lifecycle policies (can be added)
- **API Gateway**: HTTP API (cheaper than REST API)

## Security

- **Authentication**: Google OAuth 2.0 token verification
- **Authorization**: User-based access control for private resources
- **CORS**: Configured for frontend domains
- **S3**: Bucket policies restrict access to authorized users
- **DynamoDB**: IAM roles with least-privilege access

## Monitoring

AWS CloudWatch automatically monitors:
- Lambda function metrics and logs
- API Gateway request metrics
- DynamoDB performance metrics
- S3 access logs

## Troubleshooting

1. **Deployment fails**: Check AWS credentials and permissions
2. **Authentication errors**: Verify Google OAuth client ID
3. **CORS issues**: Check allowed origins in serverless.yml
4. **Database errors**: Verify DynamoDB table creation and indexes

## Contributing

1. Create feature branch
2. Add tests for new functionality
3. Update documentation
4. Submit pull request 